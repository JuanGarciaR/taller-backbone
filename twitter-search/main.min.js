(function(b){var c=Backbone.Model.extend({defaults:{created_at:"",from_user:"",from_user_id:0,from_user_id_str:"",from_user_name:"",geo:null,id:0,id_str:"",iso_language_code:"",metadata:{},profile_image_url:"",profile_image_url_https:"",source:"",text:"",to_user:null,to_user_id:null,to_user_id_str:null,to_user_name:null}}),d=Backbone.Collection.extend({model:c}),e=Backbone.View.extend({tagName:"li",className:"tweet",template:"",initialize:function(){_.bindAll(this);this.template=b("[template='tweet']").html().trim()},
events:{click:"select"},select:function(){this.$el.toggleClass("selected")},render:function(){this.$el.html(Mustache.render(this.template,this.model.toJSON()));this.delegateEvents();return this}}),f=Backbone.Model.extend({defaults:{query:null,sinceId:"",rpp:10,resultType:"popular",refreshInterval:1E4,template:"",collection:null}}),g=Backbone.View.extend({className:"tweets",collection:null,events:{"click .title .edit":"editQuery","click .title .delete":"deleteSearch","click .title-edit .save":"saveEdit",
"click .title-edit .cancel":"cancelEdit"},initialize:function(){_.bindAll(this);if(!this.options.hasOwnProperty("query"))throw"Cannot create a Search without a query string";this.model=new f(this.options);this.model.on("change:query change:template",this.render);this.collection=new d;this.collection.on("add",this.addOne);this.collection.on("remove",this.removeOne);this.collection.on("add reset remove",this.updateCounter);this.getTweets()},getTweets:function(){this.model.get("query")!=null&&b.ajax({url:"http://search.twitter.com/search.json",
dataType:"jsonp",data:{q:this.model.get("query"),since_id:this.model.get("sinceId"),rpp:this.model.get("rpp"),result_type:this.model.get("resultType")},success:this.getTweetsSuccess})},getTweetsSuccess:function(a){if(a.hasOwnProperty("error"))throw"API Error:"+a.error;a.results=_.sortBy(a.results,function(a){return a.id});this.model.set("sinceId",a.max_id);_.each(a.results,function(a){try{this.collection.add(a)}catch(b){}},this);setTimeout(this.getTweets,this.model.get("refreshInterval"))},addOne:function(a){if(a.view==
null)a.view=new e({model:a}),a.view.render();this.$(".tweets-ul").prepend(a.view.el);a.view.$el.slideDown()},removeOne:function(a){a.view!=null&&a.view.remove();a.clear()},render:function(){this.$el.html(Mustache.render(this.model.get("template"),this.model.toJSON()));this.delegateEvents();return this},editQuery:function(){this.$(".term-edit").val(this.query);this.$(".title-edit").show();this.$(".title").hide()},cancelEdit:function(){this.$(".title-edit").hide();this.$(".title").show()},saveEdit:function(){this.model.set({query:this.$(".term-edit").val(),
sinceId:""});this.collection.reset()},deleteSearch:function(){this.model.set("query",null);this.collection.reset();this.remove()},updateCounter:function(){this.$(".found").html(this.collection.size())}}),h=Backbone.View.extend({initialize:function(){_.bindAll(this)},events:{"click div.search button.add":"addSearch"},addSearch:function(){this.createSearch(b("div.search input:text.query").val());b("div.search input:text.query").val("").focus()},createSearch:function(a){a=new g({query:a,resultType:"mixed",
template:b("[template='tweetsearch']").html().trim()});this.$(".lists").append(a.render().el);a.$el.fadeIn()}});b(function(){var a=new h({el:"body"});a.createSearch("javascript");a.createSearch("php")})})(jQuery);
